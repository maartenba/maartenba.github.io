---
layout: post
title: "Protecting Windows Azure Web and Worker roles from malware"
pubDatetime: 2012-03-27T08:07:00Z
comments: true
published: true
categories: ["post"]
tags: ["Azure", "CSharp", "Debugging", "General", "Scalability", "Software"]
author: Maarten Balliauw
redirect_from:
  - /post/2012/03/27/protecting-windows-azure-web-and-worker-roles-from-malware.html
---
<p>Most IT administrators will install some sort of virus scanner on your precious servers. Since the cloud, from a technical perspective, is just a server, why not follow that security best practice on Windows Azure too? It has gone by almost unnoticed, but last week Microsoft released the <a href="http://www.microsoft.com/download/en/details.aspx?id=29209" target="_blank">Microsoft Endpoint Protection for Windows Azure Customer Technology Preview</a>. For the sake of bandwidth, I&rsquo;ll be referring to it as EP.</p>
<p>EP offers real-time protection, scheduled scanning, malware remediation (a fancy word for quarantining), active protection and automatic signature updates. Sounds a lot like <a href="http://windows.microsoft.com/en-us/windows/products/security-essentials" target="_blank">Microsoft Endpoint Protection</a> or Windows Security Essentials? That&rsquo;s no coincidence: EP is a Windows Azurified version of it.</p>
<h2>Enabling anti-malware on Windows Azure</h2>
<p>After installing the <a href="http://www.microsoft.com/download/en/details.aspx?id=29209" target="_blank">Microsoft Endpoint Protection for Windows Azure Customer Technology Preview</a>, sorry, <a href="http://www.microsoft.com/download/en/details.aspx?id=29209" target="_blank">EP</a>, a new Windows Azure import will be available. As with remote desktop or diagnostics, EP can be enabled by a simple XML one liner:</p>
<div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:6a107e5a-da7b-4759-99ab-494cba5475d8" class="wlWriterEditableSmartContent" style="margin: 0px; display: inline; float: none; padding: 0px;">
<pre style="width: 686px; height: 23px; background-color: white; overflow: auto;"><div><!--

Code highlighting produced by Actipro CodeHighlighter (freeware)
http://www.CodeHighlighter.com/

--><span style="color: #008080;">1</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Import </span><span style="color: #ff0000;">moduleName</span><span style="color: #0000ff;">="Antimalware"</span><span style="color: #ff0000;"> </span><span style="color: #0000ff;">/&gt;</span></div></pre>
<!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>Here&rsquo;s a sample web role <em>ServiceDefinition.csdef</em> file containing this new import:</p>
<div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:7a68d37f-b0b6-4d70-ac62-fbb2b59da306" class="wlWriterEditableSmartContent" style="margin: 0px; display: inline; float: none; padding: 0px;">
<pre style="width: 686px; height: 320px; background-color: white; overflow: auto;"><div><!--

Code highlighting produced by Actipro CodeHighlighter (freeware)
http://www.CodeHighlighter.com/

--><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version="1.0" encoding="utf-8"</span><span style="color: #0000ff;">?&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">ServiceDefinition </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="ChuckProject"</span><span style="color: #ff0000;"> 
</span><span style="color: #008080;"> 3</span> <span style="color: #ff0000;">                   xmlns</span><span style="color: #0000ff;">="http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceDefinition"</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">  </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">WebRole </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="ChuckNorris"</span><span style="color: #ff0000;"> vmsize</span><span style="color: #0000ff;">="Small"</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Sites</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">      </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Site </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="Web"</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">        </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Bindings</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">          </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Binding </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="Endpoint1"</span><span style="color: #ff0000;"> endpointName</span><span style="color: #0000ff;">="Endpoint1"</span><span style="color: #ff0000;"> </span><span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">        </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Bindings</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">10</span> <span style="color: #000000;">      </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Site</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">11</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Sites</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">12</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Endpoints</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">13</span> <span style="color: #000000;">      </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">InputEndpoint </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="Endpoint1"</span><span style="color: #ff0000;"> protocol</span><span style="color: #0000ff;">="http"</span><span style="color: #ff0000;"> port</span><span style="color: #0000ff;">="80"</span><span style="color: #ff0000;"> </span><span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">14</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Endpoints</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">15</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Imports</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">16</span> <span style="color: #000000;">      </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Import </span><span style="color: #ff0000;">moduleName</span><span style="color: #0000ff;">="Antimalware"</span><span style="color: #ff0000;"> </span><span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">17</span> <span style="color: #000000;">      </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Import </span><span style="color: #ff0000;">moduleName</span><span style="color: #0000ff;">="Diagnostics"</span><span style="color: #ff0000;"> </span><span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">18</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Imports</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">19</span> <span style="color: #000000;">  </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">WebRole</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">20</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">ServiceDefinition</span><span style="color: #0000ff;">&gt;</span></div></pre>
<!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>That&rsquo;s it! When you now deploy your Windows Azure solution, Microsoft Endpoint Protection will be installed, enabled and configured on your Windows Azure virtual machines.</p>
<p>Now since I started this blog post with &ldquo;IT administrators&rdquo;, chances are you want to fine-tune this plugin a little. No problem! The <em>ServiceConfiguration.cscfg</em> file has some options waiting to be eh, touched. And since these are in the service configuration, you can also modify them through the management portal, the management API, or sysadmin-style using PowerShell. Anyway, the following options are available:</p>
<ul>
<li><strong>Microsoft.WindowsAzure.Plugins.Antimalware.ServiceLocation</strong> &ndash; Specify the datacenter region where your application is deployed, for example &ldquo;West Europe&rdquo; or &ldquo;East Asia&rdquo;. This will speed up deployment time.</li>
<li><strong>Microsoft.WindowsAzure.Plugins.Antimalware.EnableAntimalware &ndash;</strong> Should EP be enabled or not?</li>
<li><strong>Microsoft.WindowsAzure.Plugins.Antimalware.EnableRealtimeProtection</strong> &ndash; Should real-time protection be enabled?</li>
<li><strong>Microsoft.WindowsAzure.Plugins.Antimalware.EnableWeeklyScheduledScans</strong> &ndash; Weekly scheduled scans enabled?</li>
<li><strong>Microsoft.WindowsAzure.Plugins.Antimalware.DayForWeeklyScheduledScans</strong> &ndash; Which day of the week (0 &ndash; 7 where 0 means daily)</li>
<li><strong>Microsoft.WindowsAzure.Plugins.Antimalware.TimeForWeeklyScheduledScans</strong> &ndash; What time should the scheduled scan run?</li>
<li><strong>Microsoft.WindowsAzure.Plugins.Antimalware.ExcludedExtensions</strong> &ndash; Specify file extensions to exclude from scanning (pip-delimited)</li>
<li><strong>Microsoft.WindowsAzure.Plugins.Antimalware.ExcludedPaths</strong> &ndash; Specify paths to exclude from scanning (pip-delimited)</li>
<li><strong>Microsoft.WindowsAzure.Plugins.Antimalware.ExcludedProcesses</strong> &ndash; Specify processes to exclude from scanning (pip-delimited)</li>
</ul>
<h2>Monitoring anti-malware on Windows Azure</h2>
<p>How will you know if a threat has been detected? Well, luckily for us, Windows Endpoint Protection writes its logs to the System event log. Which means that you can simply add a specific data source in your diagnostics monitor and you&rsquo;re done:</p>
<div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:785a5a16-1f69-4081-96e9-17697664c6f5" class="wlWriterEditableSmartContent" style="margin: 0px; display: inline; float: none; padding: 0px;">
<pre style="width: 686px; height: 223px; background-color: white; overflow: auto;"><div><!--

Code highlighting produced by Actipro CodeHighlighter (freeware)
http://www.CodeHighlighter.com/

--><span style="color: #008080;"> 1</span> <span style="color: #000000;">var configuration </span><span style="color: #000000;">=</span><span style="color: #000000;"> DiagnosticMonitor.GetDefaultInitialConfiguration();
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">
</span><span style="color: #008080;"> 3</span> <span style="color: #008000;">//</span><span style="color: #008000;"> Note: if you need informational / verbose, also subscribe to levels 4 and 5</span><span style="color: #008000;">
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">configuration.WindowsEventLog.DataSources.Add(
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">    </span><span style="color: #800000;">"</span><span style="color: #800000;">System!*[System[Provider[@Name='Microsoft Antimalware'] and (Level=1 or Level=2 or Level=3)]]</span><span style="color: #800000;">"</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">configuration.WindowsEventLog.ScheduledTransferPeriod 
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    </span><span style="color: #000000;">=</span><span style="color: #000000;"> System.TimeSpan.FromMinutes(</span><span style="color: #800080;">1</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    
</span><span style="color: #008080;">10</span> <span style="color: #000000;">DiagnosticMonitor.Start(
</span><span style="color: #008080;">11</span> <span style="color: #000000;">    </span><span style="color: #800000;">"</span><span style="color: #800000;">Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString</span><span style="color: #800000;">"</span><span style="color: #000000;">,
</span><span style="color: #008080;">12</span> <span style="color: #000000;">    configuration);</span></div></pre>
<!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>In addition, EP also logs its inner workings to its installation folders. You can also include these in your diagnostics configuration:</p>
<div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:94e4cd9c-3e73-44e2-a146-441e70b2dd14" class="wlWriterEditableSmartContent" style="margin: 0px; display: inline; float: none; padding: 0px;">
<pre style="width: 686px; height: 330px; background-color: white; overflow: auto;"><div><!--

Code highlighting produced by Actipro CodeHighlighter (freeware)
http://www.CodeHighlighter.com/

--><span style="color: #008080;"> 1</span> <span style="color: #000000;">var configuration </span><span style="color: #000000;">=</span><span style="color: #000000;"> DiagnosticMonitor.GetDefaultInitialConfiguration();
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">
</span><span style="color: #008080;"> 3</span> <span style="color: #008000;">//</span><span style="color: #008000;"> ...add the event logs like in the previous code sample...</span><span style="color: #008000;">
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">var mep1 </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> DirectoryConfiguration();
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">mep1.Container </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800000;">"</span><span style="color: #800000;">wad-endpointprotection-container</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">mep1.DirectoryQuotaInMB </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">5</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">mep1.Path </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800000;">"</span><span style="color: #800000;">%programdata%\Microsoft Endpoint Protection</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">
</span><span style="color: #008080;">10</span> <span style="color: #000000;">var mep2 </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> DirectoryConfiguration();
</span><span style="color: #008080;">11</span> <span style="color: #000000;">mep2.Container </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800000;">"</span><span style="color: #800000;">wad-endpointprotection-container</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">12</span> <span style="color: #000000;">mep2.DirectoryQuotaInMB </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">5</span><span style="color: #000000;">;
</span><span style="color: #008080;">13</span> <span style="color: #000000;">mep2.Path </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800000;">"</span><span style="color: #800000;">%programdata%\Microsoft\Microsoft Security Client</span><span style="color: #800000;">"</span><span style="color: #000000;">;
</span><span style="color: #008080;">14</span> <span style="color: #000000;">
</span><span style="color: #008080;">15</span> <span style="color: #000000;">configuration.Directories.ScheduledTransferPeriod </span><span style="color: #000000;">=</span><span style="color: #000000;"> TimeSpan.FromMinutes(</span><span style="color: #800080;">1.0</span><span style="color: #000000;">);
</span><span style="color: #008080;">16</span> <span style="color: #000000;">configuration.Directories.DataSources.Add(mep1);
</span><span style="color: #008080;">17</span> <span style="color: #000000;">configuration.Directories.DataSources.Add(mep2);
</span><span style="color: #008080;">18</span> <span style="color: #000000;">    
</span><span style="color: #008080;">19</span> <span style="color: #000000;">DiagnosticMonitor.Start(
</span><span style="color: #008080;">20</span> <span style="color: #000000;">    </span><span style="color: #800000;">"</span><span style="color: #800000;">Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString</span><span style="color: #800000;">"</span><span style="color: #000000;">,
</span><span style="color: #008080;">21</span> <span style="color: #000000;">    configuration);</span></div></pre>
<!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>From this moment one, you can use a tool like <a href="http://www.cerebrata.com/Products/AzureDiagnosticsManager/" target="_blank">Cerebrata&rsquo;s Diagnostics Monitor</a> to check the event logs of all your Windows Azure instances that have anti-malware enabled.</p>



