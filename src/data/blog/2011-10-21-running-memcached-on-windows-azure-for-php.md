---
layout: post
title: "Running Memcached on Windows Azure for PHP"
pubDatetime: 2011-10-21T15:44:00Z
comments: true
published: true
categories: ["post"]
tags: ["Azure", "General", "PHP", "Scalability", "Software", "Webfarm"]
author: Maarten Balliauw
redirect_from:
  - /post/2011/10/21/running-memcached-on-windows-azure-for-php.html
---
<p>After three conferences in two weeks with a lot of &ldquo;airport time&rdquo;, which typically converts into &ldquo;let&rsquo;s code!&rdquo; time, I think I may have tackled a commonly requested Windows Azure feature for PHP developers. Some sort of distributed caching is always a great thing to have when building scalable services and applications. While Windows Azure offers a distributed caching layer under the form of the <a href="http://www.microsoft.com/windowsazure/features/caching/" target="_blank">Windows Azure Caching</a>, that components currently lacks support for non-.NET technologies. I&rsquo;ve heard there&rsquo;s work being done there, but that&rsquo;s not very interesting if you are building your app today. This blog post will show you how to modify a Windows Azure deployment to run and use <a href="http://memcached.org/" target="_blank">Memcached</a> in the easiest possible manner.</p>
<p><em>Note: this post focuses on PHP but can also be used to setup Memcached on Windows Azure for NodeJS, Java, Ruby, Python, &hellip;</em></p>
<p><strong>Related downloads:</strong> <br />The scaffolder source code: <a href="/files/2011/10/MemcachedScaffolderSource.zip">MemcachedScaffolderSource.zip (1.12 mb)</a><br />The scaffolder, packaged and ready for use: <a href="/files/2011/10/MemcachedScaffolder.phar">MemcachedScaffolder.phar (2.87 mb)</a></p>
<h2>The short version: use my scaffolder</h2>
<p>As you may know, when working with PHP on Windows Azure and when making use of the Windows Azure SDK, you can use and create <a href="/post/2011/05/30/Scaffolding-and-packaging-a-Windows-Azure-project-in-PHP.aspx" target="_blank">scaffolders</a>. The <a href="http://phpazure.codeplex.com" target="_blank">Windows Azure SDK for PHP</a> includes a powerful scaffolding feature that allows users to quickly setup a pre-packaged and configured website ready for Windows Azure.</p>
<p>If you want to use Memcached in your project, do the following:</p>
<ul>
<li>Download my custom MemcacheScaffolder (<a href="/files/2011/10/MemcachedScaffolder.phar">MemcachedScaffolder.phar (2.87 mb)</a>) and make sure it is located either under the <em>scaffolders</em> folder of the Windows Azure SDK for PHP, or that you remember the path to this scaffolder </li>
<li>Run the scaffolder from the command line: (note: best use the latest SVN version of the command line tools)</li>
</ul>
<div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:fd18a1d2-b76a-4218-84c8-405a8c146fe0" class="wlWriterEditableSmartContent" style="margin: 0px; display: inline; float: none; padding: 0px;">
<pre style="width: 583px; height: 28px; background-color: white; overflow: auto;"><div><!--

Code highlighting produced by Actipro CodeHighlighter (freeware)
http://www.CodeHighlighter.com/

--><span style="color: #008080;">1</span> <span style="color: #000000;">scaffolder </span><span style="color: #0000ff;">run</span><span style="color: #000000;"> -out</span><span style="color: #000000;">=</span><span style="color: #000000;">"</span><span style="color: #000000;">c:\temp\myapp</span><span style="color: #000000;">"</span><span style="color: #000000;"> -s</span><span style="color: #000000;">=</span><span style="color: #000000;">"</span><span style="color: #000000;">MemcachedScaffolder</span><span style="color: #000000;">"</span></div></pre>
<!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p><span style="font-family: Courier New;"><em></em>
<li>Find the newly created Windows Azure project structure in the folder you&rsquo;ve used. </li>
<li>In your PHP code, simply add<span style="font-family: Courier New;"><em> require_once 'memcache.inc.php';</em></span> to your code, and enjoy the <em><span style="font-family: Courier New;">$memcache</span></em> variable which will hold a preconfigured Memcached client for you to use. This<span style="font-family: Courier New;"><em> $memcache</em></span> instance will also be automatically updated when adding more server instances or deleting server instances.</li>
</span></p>
<div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:7fe333ae-b357-49ca-b9b9-7a1c3c9287d9" class="wlWriterEditableSmartContent" style="margin: 0px; display: inline; float: none; padding: 0px;">
<pre style="width: 583px; height: 15px; background-color: white; overflow: auto;"><div><!--

Code highlighting produced by Actipro CodeHighlighter (freeware)
http://www.CodeHighlighter.com/

--><span style="color: #008080;">1</span> <span style="color: #0000ff;">require_once</span><span style="color: #000000;"> </span><span style="color: #000000;">'</span><span style="color: #000000;">memcache.inc.php</span><span style="color: #000000;">'</span><span style="color: #000000;">; </span></div></pre>
<!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>That&rsquo;s it!</p>
<h2>The long version: what this scaffolder does behind the scenes</h2>
<p>Of course, behind this &ldquo;developers can simply use 1 line of code&rdquo; trick a lot of things happen in the background. Let&rsquo;s go through the places I&rsquo;ve made changes from the default scaffolder.</p>
<h3>The ServiceDefinition.csdef file</h3>
<p>Let&rsquo;s start with the beginning: when running Memcached in a Windows Azure instance, you&rsquo;ll have to specify it with a port number to use. As such, the <em>ServiceDefinition.csdef</em> file which defines what the datacenter configuration for your app should be looks like the following:</p>
<div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:1c54fb47-76e7-4b71-9a1a-a1de6e04729b" class="wlWriterEditableSmartContent" style="margin: 0px; display: inline; float: none; padding: 0px;">
<pre style="width: 583px; height: 526px; background-color: white; overflow: auto;"><div><!--

Code highlighting produced by Actipro CodeHighlighter (freeware)
http://www.CodeHighlighter.com/

--><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version="1.0" encoding="utf-8"</span><span style="color: #0000ff;">?&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">ServiceDefinition </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="PhpOnAzure"</span><span style="color: #ff0000;"> xmlns</span><span style="color: #0000ff;">="http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceDefinition"</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;"> 3</span> <span style="color: #000000;">  </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">WebRole </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="PhpOnAzure.Web"</span><span style="color: #ff0000;"> enableNativeCodeExecution</span><span style="color: #0000ff;">="true"</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Sites</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;"> 5</span> <span style="color: #000000;">      </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Site </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="Web"</span><span style="color: #ff0000;"> physicalDirectory</span><span style="color: #0000ff;">="./PhpOnAzure.Web"</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">        </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Bindings</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">          </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Binding </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="Endpoint1"</span><span style="color: #ff0000;"> endpointName</span><span style="color: #0000ff;">="HttpEndpoint"</span><span style="color: #ff0000;"> </span><span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">        </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Bindings</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">      </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Site</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">10</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Sites</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">11</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Startup</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">12</span> <span style="color: #000000;">      </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Task </span><span style="color: #ff0000;">commandLine</span><span style="color: #0000ff;">="add-environment-variables.cmd"</span><span style="color: #ff0000;"> executionContext</span><span style="color: #0000ff;">="elevated"</span><span style="color: #ff0000;"> taskType</span><span style="color: #0000ff;">="simple"</span><span style="color: #ff0000;"> </span><span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">13</span> <span style="color: #000000;">      </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Task </span><span style="color: #ff0000;">commandLine</span><span style="color: #0000ff;">="install-php.cmd"</span><span style="color: #ff0000;"> executionContext</span><span style="color: #0000ff;">="elevated"</span><span style="color: #ff0000;"> taskType</span><span style="color: #0000ff;">="simple"</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">14</span> <span style="color: #000000;">        </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Environment</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">15</span> <span style="color: #000000;">          </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Variable </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="EMULATED"</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">16</span> <span style="color: #000000;">            </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RoleInstanceValue </span><span style="color: #ff0000;">xpath</span><span style="color: #0000ff;">="/RoleEnvironment/Deployment/@emulated"</span><span style="color: #ff0000;"> </span><span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">17</span> <span style="color: #000000;">          </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Variable</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">18</span> <span style="color: #000000;">        </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Environment</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">19</span> <span style="color: #000000;">      </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Task</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">20</span> <span style="color: #000000;">      </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Task </span><span style="color: #ff0000;">commandLine</span><span style="color: #0000ff;">="memcached.cmd"</span><span style="color: #ff0000;"> executionContext</span><span style="color: #0000ff;">="elevated"</span><span style="color: #ff0000;"> taskType</span><span style="color: #0000ff;">="background"</span><span style="color: #ff0000;"> </span><span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">21</span> <span style="color: #000000;">      </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Task </span><span style="color: #ff0000;">commandLine</span><span style="color: #0000ff;">="monitor-environment.cmd"</span><span style="color: #ff0000;"> executionContext</span><span style="color: #0000ff;">="elevated"</span><span style="color: #ff0000;"> taskType</span><span style="color: #0000ff;">="background"</span><span style="color: #ff0000;"> </span><span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">22</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Startup</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">23</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Endpoints</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">24</span> <span style="color: #000000;">      </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">InputEndpoint </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="HttpEndpoint"</span><span style="color: #ff0000;"> protocol</span><span style="color: #0000ff;">="http"</span><span style="color: #ff0000;"> port</span><span style="color: #0000ff;">="80"</span><span style="color: #ff0000;"> </span><span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">25</span> <span style="color: #000000;">      </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">InternalEndpoint </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">="MemcachedEndpoint"</span><span style="color: #ff0000;"> protocol</span><span style="color: #0000ff;">="tcp"</span><span style="color: #ff0000;"> </span><span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">26</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Endpoints</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">27</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Imports</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">28</span> <span style="color: #000000;">      </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Import </span><span style="color: #ff0000;">moduleName</span><span style="color: #0000ff;">="Diagnostics"</span><span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">29</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">Imports</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">30</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">ConfigurationSettings</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">31</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">ConfigurationSettings</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">32</span> <span style="color: #000000;">  </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">WebRole</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
</span><span style="color: #008080;">33</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">ServiceDefinition</span><span style="color: #0000ff;">&gt;</span></div></pre>
<!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>Note the <em>&lt;InternalEndpoint name="MemcachedEndpoint" protocol="tcp" /&gt; </em>line of code. This one defines that the web role instance should open some TCP port in the firewall with the name <em>MemcachedEndpoint</em> and expose that to the other virtual machines in your deployment. We&rsquo;ll use this named endpoint later when starting Memcached.</p>
<p>Something else in this file is noteworthy: the startup tasks under the <em>&lt;Startup&gt;</em> element. With the default scaffolder, the first two tasks (namely <em>add-environment-variables.cmd </em>and <em>install-php.cmd</em>) are also present. These do nothing more than providing some environment information about your deployment in the environment variables. The second one does what its name implies: install PHP on your virtual machine. The latter two scripts added, <em>memcached.cmd</em> and <em>monitor-environment.cmd</em> are used to bootstrap Memcached. Note these two tasks run as <em>background</em> tasks: I wanted to have these two always running to ensure when Memcached crashes the task can simply restart Memcached.</p>
<h3>The <em>php</em> folder</h3>
<p>If you&rsquo;ve played with the default scaffolder in the <a href="http://phpazure.codeplex.com" target="_blank">Windows Azure SDK for PHP</a>, you probably know that the PHP installation in Windows Azure is a &ldquo;default&rdquo; one. This means: no memcached extension is in there. To overcome this, simply copy the correct <em><a href="http://downloads.php.net/pierre/" target="_blank">php_memcache.dll</a></em> extension into the <em>/php/ext</em> folder and Windows Azure (well, the <em>install-php.cmd</em> script) will know what to do with it.</p>
<h3>Memcached.cmd and Memcached.ps1</h3>
<p>Under the application&rsquo;s <em>bin</em> folder, I&rsquo;ve added some additional startup tasks. The one responsible for starting (and maintaining a running instance of) Memcached is, of course, Memcached.cmd. This one simply delegates the call to Memcached.ps1, of which the following is the source code:</p>
<div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:9177c6d7-6e41-43f6-aff4-596e7579d630" class="wlWriterEditableSmartContent" style="margin: 0px; display: inline; float: none; padding: 0px;">
<pre style="width: 583px; height: 145px; background-color: white; overflow: auto;"><div><!--

Code highlighting produced by Actipro CodeHighlighter (freeware)
http://www.CodeHighlighter.com/

--><span style="color: #008080;">1</span> <span style="color: #000000;">[Reflection.Assembly]</span><span style="color: #000000;">::</span><span style="color: #000000;">LoadWithPartialName(</span><span style="color: #800000;">"</span><span style="color: #800000;">Microsoft.WindowsAzure.ServiceRuntime</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;">2</span> <span style="color: #000000;">
</span><span style="color: #008080;">3</span> <span style="color: #008000;">#</span><span style="color: #008000;"> Start memcached. To infinity and beyond!</span><span style="color: #008000;">
</span><span style="color: #008080;">4</span> <span style="color: #0000ff;">while</span><span style="color: #000000;"> (</span><span style="color: #000000;">1</span><span style="color: #000000;">) {
</span><span style="color: #008080;">5</span> <span style="color: #000000;">    </span><span style="color: #800080;">$p</span><span style="color: #000000;"> </span><span style="color: #000000;">=</span><span style="color: #000000;"> [diagnostics.</span><span style="color: #0000ff;">process</span><span style="color: #000000;">]</span><span style="color: #000000;">::</span><span style="color: #000000;">Start(</span><span style="color: #800000;">"</span><span style="color: #800000;">memcached.exe</span><span style="color: #800000;">"</span><span style="color: #000000;">, </span><span style="color: #800000;">"</span><span style="color: #800000;">-m 64 -p </span><span style="color: #800000;">"</span><span style="color: #000000;"> </span><span style="color: #000000;">+</span><span style="color: #000000;"> [Microsoft.WindowsAzure.ServiceRuntime.RoleEnvironment]</span><span style="color: #000000;">::</span><span style="color: #000000;">CurrentRoleInstance.InstanceEndpoints[</span><span style="color: #800000;">"</span><span style="color: #800000;">MemcachedEndpoint</span><span style="color: #800000;">"</span><span style="color: #000000;">].IPEndpoint.Port)
</span><span style="color: #008080;">6</span> <span style="color: #000000;">    </span><span style="color: #800080;">$p</span><span style="color: #000000;">.WaitForExit()
</span><span style="color: #008080;">7</span> <span style="color: #000000;">}</span></div></pre>
<!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>To be honest, this file is pretty simple. It loads the WindowsAzure ServiceRuntime assembly which contains all kinds of information about the current deployment. Next, I start an infinite loop which continuously starts a new <em>memcached.exe</em> process consuming 64MB of RAM memory and listens on the port specified by the <em>MemcachedEndpoint</em> defined earlier.</p>
<h3>Monitor-environment.cmd and Monitor-environment.ps1</h3>
<p>The <em>monitor-environment.cmd</em> script takes the same approach as the <em>memcached.cmd</em> script: just pass the command along to a PowerShell script in the form of <em>monitor-environment.ps1</em>. I do want to show you the <em>monitor-environment.cmd </em>script however, as there&rsquo;s one difference in there: I&rsquo;m changing the file system permissions for my application (the <em>icacls</em> line).</p>
<div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:bfe86512-4f8e-4172-867e-86eb10435f90" class="wlWriterEditableSmartContent" style="margin: 0px; display: inline; float: none; padding: 0px;">
<pre style="width: 583px; height: 107px; background-color: white; overflow: auto;"><div><!--

Code highlighting produced by Actipro CodeHighlighter (freeware)
http://www.CodeHighlighter.com/

--><span style="color: #008080;">1</span> <span style="color: #000000;">@</span><span style="color: #000000;">echo off
</span><span style="color: #008080;">2</span> <span style="color: #000000;">cd </span><span style="color: #800000;">"</span><span style="color: #800000;">%~dp0</span><span style="color: #800000;">"</span><span style="color: #000000;">
</span><span style="color: #008080;">3</span> <span style="color: #000000;">
</span><span style="color: #008080;">4</span> <span style="color: #000000;">icacls </span><span style="color: #000000;">%</span><span style="color: #000000;">RoleRoot</span><span style="color: #000000;">%</span><span style="color: #000000;">\approot </span><span style="color: #000000;">/</span><span style="color: #000000;">grant </span><span style="color: #800000;">"</span><span style="color: #800000;">Everyone</span><span style="color: #800000;">"</span><span style="color: #000000;">:F </span><span style="color: #000000;">/</span><span style="color: #000000;">T
</span><span style="color: #008080;">5</span> <span style="color: #000000;">
</span><span style="color: #008080;">6</span> <span style="color: #000000;">powershell.exe Set</span><span style="color: #000000;">-</span><span style="color: #000000;">ExecutionPolicy Unrestricted
</span><span style="color: #008080;">7</span> <span style="color: #000000;">powershell.exe .\monitor</span><span style="color: #000000;">-</span><span style="color: #000000;">environment.ps1</span></div></pre>
<!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>The reason for changing permissions is simple: I want to make sure I can write a PHP script to disk every minute. Yes, you heard me! I&rsquo;m using PowerShell (in the <em>monitor-environment.ps1 </em>script) to generate PHP code. Here&rsquo;s the PowerShell:</p>
<div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:0f50567e-2397-4305-a398-8940930d69c1" class="wlWriterEditableSmartContent" style="margin: 0px; display: inline; float: none; padding: 0px;">
<pre style="width: 583px; height: 659px; background-color: white; overflow: auto;"><div><!--

Code highlighting produced by Actipro CodeHighlighter (freeware)
http://www.CodeHighlighter.com/

--><span style="color: #008080;"> 1</span> <span style="color: #000000;">[Reflection.Assembly]</span><span style="color: #000000;">::</span><span style="color: #000000;">LoadWithPartialName(</span><span style="color: #800000;">"</span><span style="color: #800000;">Microsoft.WindowsAzure.ServiceRuntime</span><span style="color: #800000;">"</span><span style="color: #000000;">)
</span><span style="color: #008080;"> 2</span> <span style="color: #000000;">
</span><span style="color: #008080;"> 3</span> <span style="color: #008000;">#</span><span style="color: #008000;"> To infinity and beyond!</span><span style="color: #008000;">
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">
</span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">while</span><span style="color: #000000;">(</span><span style="color: #000000;">1</span><span style="color: #000000;">) {
</span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    </span><span style="color: #008000;">#</span><span style="color: #008000;">#########################################################</span><span style="color: #008000;">
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">    </span><span style="color: #008000;">#</span><span style="color: #008000;"> Create memcached include file for PHP</span><span style="color: #008000;">
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    </span><span style="color: #008000;">#</span><span style="color: #008000;">#########################################################</span><span style="color: #008000;">
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">
</span><span style="color: #008080;">10</span> <span style="color: #000000;">    </span><span style="color: #008000;">#</span><span style="color: #008000;"> Dump all memcached endpoints to ../memcached-servers.php</span><span style="color: #008000;">
</span><span style="color: #008080;">11</span> <span style="color: #000000;">    </span><span style="color: #800080;">$memcached</span><span style="color: #000000;"> </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800000;">"</span><span style="color: #800000;">&lt;?php`r`n</span><span style="color: #800000;">"</span><span style="color: #000000;">
</span><span style="color: #008080;">12</span> <span style="color: #000000;">    </span><span style="color: #800080;">$memcached</span><span style="color: #000000;"> </span><span style="color: #000000;">+=</span><span style="color: #000000;"> </span><span style="color: #800000;">"</span><span style="color: #800000;">`$memcachedServers = array(</span><span style="color: #800000;">"</span><span style="color: #000000;">
</span><span style="color: #008080;">13</span> <span style="color: #000000;">
</span><span style="color: #008080;">14</span> <span style="color: #000000;">    </span><span style="color: #800080;">$currentRolename</span><span style="color: #000000;"> </span><span style="color: #000000;">=</span><span style="color: #000000;"> [Microsoft.WindowsAzure.ServiceRuntime.RoleEnvironment]</span><span style="color: #000000;">::</span><span style="color: #000000;">CurrentRoleInstance.Role.Name
</span><span style="color: #008080;">15</span> <span style="color: #000000;">    </span><span style="color: #800080;">$roles</span><span style="color: #000000;"> </span><span style="color: #000000;">=</span><span style="color: #000000;"> [Microsoft.WindowsAzure.ServiceRuntime.RoleEnvironment]</span><span style="color: #000000;">::</span><span style="color: #000000;">Roles
</span><span style="color: #008080;">16</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">foreach</span><span style="color: #000000;"> (</span><span style="color: #800080;">$role</span><span style="color: #000000;"> </span><span style="color: #0000ff;">in</span><span style="color: #000000;"> </span><span style="color: #800080;">$roles</span><span style="color: #000000;">.Keys </span><span style="color: #000000;">|</span><span style="color: #000000;"> sort</span><span style="color: #000000;">-</span><span style="color: #000000;">object) {
</span><span style="color: #008080;">17</span> <span style="color: #000000;">        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (</span><span style="color: #800080;">$role</span><span style="color: #000000;"> </span><span style="color: #008080;">-eq</span><span style="color: #000000;"> </span><span style="color: #800080;">$currentRolename</span><span style="color: #000000;">) {
</span><span style="color: #008080;">18</span> <span style="color: #000000;">            </span><span style="color: #800080;">$instances</span><span style="color: #000000;"> </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">$roles</span><span style="color: #000000;">[</span><span style="color: #800080;">$role</span><span style="color: #000000;">].Instances
</span><span style="color: #008080;">19</span> <span style="color: #000000;">            </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> (</span><span style="color: #800080;">$i</span><span style="color: #000000;"> </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #000000;">0</span><span style="color: #000000;">; </span><span style="color: #800080;">$i</span><span style="color: #000000;"> </span><span style="color: #008080;">-lt</span><span style="color: #000000;"> </span><span style="color: #800080;">$instances</span><span style="color: #000000;">.Count; </span><span style="color: #800080;">$i</span><span style="color: #000000;">++</span><span style="color: #000000;">) {
</span><span style="color: #008080;">20</span> <span style="color: #000000;">                </span><span style="color: #800080;">$endpoints</span><span style="color: #000000;"> </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #800080;">$instances</span><span style="color: #000000;">[</span><span style="color: #800080;">$i</span><span style="color: #000000;">].InstanceEndpoints
</span><span style="color: #008080;">21</span> <span style="color: #000000;">                </span><span style="color: #0000ff;">foreach</span><span style="color: #000000;"> (</span><span style="color: #800080;">$endpoint</span><span style="color: #000000;"> </span><span style="color: #0000ff;">in</span><span style="color: #000000;"> </span><span style="color: #800080;">$endpoints</span><span style="color: #000000;">.Keys </span><span style="color: #000000;">|</span><span style="color: #000000;"> sort</span><span style="color: #000000;">-</span><span style="color: #000000;">object) {
</span><span style="color: #008080;">22</span> <span style="color: #000000;">                    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (</span><span style="color: #800080;">$endpoint</span><span style="color: #000000;"> </span><span style="color: #008080;">-eq</span><span style="color: #000000;"> </span><span style="color: #800000;">"</span><span style="color: #800000;">MemcachedEndpoint</span><span style="color: #800000;">"</span><span style="color: #000000;">) {
</span><span style="color: #008080;">23</span> <span style="color: #000000;">                        </span><span style="color: #800080;">$memcached</span><span style="color: #000000;"> </span><span style="color: #000000;">+=</span><span style="color: #000000;"> </span><span style="color: #800000;">"</span><span style="color: #800000;">array(`"</span><span style="color: #800000;">"</span><span style="color: #000000;">
</span><span style="color: #008080;">24</span> <span style="color: #000000;">                        </span><span style="color: #800080;">$memcached</span><span style="color: #000000;"> </span><span style="color: #000000;">+=</span><span style="color: #000000;"> </span><span style="color: #800080;">$endpoints</span><span style="color: #000000;">[</span><span style="color: #800080;">$endpoint</span><span style="color: #000000;">].IPEndpoint.Address
</span><span style="color: #008080;">25</span> <span style="color: #000000;">                        </span><span style="color: #800080;">$memcached</span><span style="color: #000000;"> </span><span style="color: #000000;">+=</span><span style="color: #000000;"> </span><span style="color: #800000;">"</span><span style="color: #800000;">`" ,</span><span style="color: #800000;">"</span><span style="color: #000000;">
</span><span style="color: #008080;">26</span> <span style="color: #000000;">                        </span><span style="color: #800080;">$memcached</span><span style="color: #000000;"> </span><span style="color: #000000;">+=</span><span style="color: #000000;"> </span><span style="color: #800080;">$endpoints</span><span style="color: #000000;">[</span><span style="color: #800080;">$endpoint</span><span style="color: #000000;">].IPEndpoint.Port
</span><span style="color: #008080;">27</span> <span style="color: #000000;">                        </span><span style="color: #800080;">$memcached</span><span style="color: #000000;"> </span><span style="color: #000000;">+=</span><span style="color: #000000;"> </span><span style="color: #800000;">"</span><span style="color: #800000;">), </span><span style="color: #800000;">"</span><span style="color: #000000;">
</span><span style="color: #008080;">28</span> <span style="color: #000000;">                    }
</span><span style="color: #008080;">29</span> <span style="color: #000000;">
</span><span style="color: #008080;">30</span> <span style="color: #000000;">
</span><span style="color: #008080;">31</span> <span style="color: #000000;">                }
</span><span style="color: #008080;">32</span> <span style="color: #000000;">            }
</span><span style="color: #008080;">33</span> <span style="color: #000000;">        }
</span><span style="color: #008080;">34</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">35</span> <span style="color: #000000;">
</span><span style="color: #008080;">36</span> <span style="color: #000000;">    </span><span style="color: #800080;">$memcached</span><span style="color: #000000;"> </span><span style="color: #000000;">+=</span><span style="color: #000000;"> </span><span style="color: #800000;">"</span><span style="color: #800000;">);</span><span style="color: #800000;">"</span><span style="color: #000000;">
</span><span style="color: #008080;">37</span> <span style="color: #000000;">
</span><span style="color: #008080;">38</span> <span style="color: #000000;">    Write</span><span style="color: #000000;">-</span><span style="color: #000000;">Output </span><span style="color: #800080;">$memcached</span><span style="color: #000000;"> </span><span style="color: #000000;">|</span><span style="color: #000000;"> Out</span><span style="color: #008080;">-File</span><span style="color: #000000;"> </span><span style="color: #000000;">-</span><span style="color: #000000;">Encoding Ascii ..</span><span style="color: #000000;">/</span><span style="color: #000000;">memcached</span><span style="color: #000000;">-</span><span style="color: #000000;">servers.php
</span><span style="color: #008080;">39</span> <span style="color: #000000;">
</span><span style="color: #008080;">40</span> <span style="color: #000000;">    </span><span style="color: #008000;">#</span><span style="color: #008000;"> Restart the loop in 1 minute</span><span style="color: #008000;">
</span><span style="color: #008080;">41</span> <span style="color: #000000;">    Start</span><span style="color: #000000;">-</span><span style="color: #000000;">Sleep </span><span style="color: #000000;">-</span><span style="color: #000000;">Seconds </span><span style="color: #000000;">60</span><span style="color: #000000;">
</span><span style="color: #008080;">42</span> <span style="color: #000000;">}</span></div></pre>
<!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>The output is being written every minute to the <em>memcached-servers.php</em> file. Why every minute? Well, if servers are added or removed I want my application to use the correct set of servers. This leaves a possible gap of one minute where some server may not be available, you can easily catch any error related to this in your PHP code (or add a comment to this blog post telling me what&rsquo;s a better interval). Anyway, here&rsquo;s the sample output:</p>
<div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:b8d0fee4-5f15-4ae2-aad6-b1d996f7f8cc" class="wlWriterEditableSmartContent" style="margin: 0px; display: inline; float: none; padding: 0px;">
<pre style="width: 583px; height: 43px; background-color: white; overflow: auto;"><div><!--

Code highlighting produced by Actipro CodeHighlighter (freeware)
http://www.CodeHighlighter.com/

--><span style="color: #008080;">1</span> <span style="color: #000000;">&lt;?</span><span style="color: #000000;">php
</span><span style="color: #008080;">2</span> <span style="color: #800080;">$memcachedServers</span><span style="color: #000000;"> </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">array</span><span style="color: #000000;">(</span><span style="color: #0000ff;">array</span><span style="color: #000000;">(</span><span style="color: #000000;">'</span><span style="color: #000000;">10.0.0.1</span><span style="color: #000000;">'</span><span style="color: #000000;">,</span><span style="color: #000000;"> </span><span style="color: #000000;">11211</span><span style="color: #000000;">)</span><span style="color: #000000;">,</span><span style="color: #000000;"> </span><span style="color: #0000ff;">array</span><span style="color: #000000;">(</span><span style="color: #000000;">'</span><span style="color: #000000;">10.0.0.2</span><span style="color: #000000;">'</span><span style="color: #000000;">,</span><span style="color: #000000;"> </span><span style="color: #000000;">11211</span><span style="color: #000000;">)</span><span style="color: #000000;">,</span><span style="color: #000000;"> );</span></div></pre>
<!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>All there&rsquo;s left to do is consume this array. I&rsquo;ve added a default <em>memcache.inc.php</em> file in the root of the web role to make things easy:</p>
<div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:fdf51df9-edbb-4563-b2ed-1b8cdabb6fe3" class="wlWriterEditableSmartContent" style="margin: 0px; display: inline; float: none; padding: 0px;">
<pre style="width: 583px; height: 158px; background-color: white; overflow: auto;"><div><!--

Code highlighting produced by Actipro CodeHighlighter (freeware)
http://www.CodeHighlighter.com/

--><span style="color: #008080;">1</span> <span style="color: #000000;">&lt;?</span><span style="color: #000000;">php
</span><span style="color: #008080;">2</span> <span style="color: #0000ff;">require_once</span><span style="color: #000000;"> </span><span style="color: #800080;">$_SERVER</span><span style="color: #000000;">[</span><span style="color: #000000;">"</span><span style="color: #000000;">RoleRoot</span><span style="color: #000000;">"</span><span style="color: #000000;">] </span><span style="color: #000000;">.</span><span style="color: #000000;"> </span><span style="color: #000000;">'</span><span style="color: #000000;">\\approot\\memcached-servers.php</span><span style="color: #000000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">3</span> <span style="color: #800080;">$memcache</span><span style="color: #000000;"> </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000ff;">new</span><span style="color: #000000;"> Memcache();
</span><span style="color: #008080;">4</span> <span style="color: #0000ff;">foreach</span><span style="color: #000000;"> (</span><span style="color: #800080;">$memcachedServers</span><span style="color: #000000;"> </span><span style="color: #0000ff;">as</span><span style="color: #000000;"> </span><span style="color: #800080;">$memcachedServer</span><span style="color: #000000;">) {
</span><span style="color: #008080;">5</span> <span style="color: #000000;">    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (</span><span style="color: #008080;">strpos</span><span style="color: #000000;">(</span><span style="color: #800080;">$memcachedServer</span><span style="color: #000000;">[</span><span style="color: #000000;">0</span><span style="color: #000000;">]</span><span style="color: #000000;">,</span><span style="color: #000000;"> </span><span style="color: #000000;">'</span><span style="color: #000000;">127.</span><span style="color: #000000;">'</span><span style="color: #000000;">) </span><span style="color: #000000;">!==</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">) {
</span><span style="color: #008080;">6</span> <span style="color: #000000;">        </span><span style="color: #800080;">$memcachedServer</span><span style="color: #000000;">[</span><span style="color: #000000;">0</span><span style="color: #000000;">] </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #000000;">'</span><span style="color: #000000;">localhost</span><span style="color: #000000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;">7</span> <span style="color: #000000;">    }
</span><span style="color: #008080;">8</span> <span style="color: #000000;">    </span><span style="color: #800080;">$memcache</span><span style="color: #000000;">-&gt;</span><span style="color: #000000;">addServer(</span><span style="color: #800080;">$memcachedServer</span><span style="color: #000000;">[</span><span style="color: #000000;">0</span><span style="color: #000000;">]</span><span style="color: #000000;">,</span><span style="color: #000000;"> </span><span style="color: #800080;">$memcachedServer</span><span style="color: #000000;">[</span><span style="color: #000000;">1</span><span style="color: #000000;">]);
</span><span style="color: #008080;">9</span> <span style="color: #000000;">}</span></div></pre>
<!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>Include this file in your code and you have a full-blown distributed cache available in your Windows Azure deployment! Here&rsquo;s a sample of some operations that can be done on Memcached:</p>
<div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:fb83ab8b-205e-4c73-a794-af2caf273b79" class="wlWriterEditableSmartContent" style="margin: 0px; display: inline; float: none; padding: 0px;">
<pre style="width: 583px; height: 210px; background-color: white; overflow: auto;"><div><!--

Code highlighting produced by Actipro CodeHighlighter (freeware)
http://www.CodeHighlighter.com/

--><span style="color: #008080;"> 1</span> <span style="color: #000000;">&lt;?</span><span style="color: #000000;">php
</span><span style="color: #008080;"> 2</span> <span style="color: #008080;">error_reporting</span><span style="color: #000000;">(</span><span style="color: #ff00ff;">E_ALL</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">require_once</span><span style="color: #000000;"> </span><span style="color: #000000;">'</span><span style="color: #000000;">memcache.inc.php</span><span style="color: #000000;">'</span><span style="color: #000000;">;
</span><span style="color: #008080;"> 4</span> <span style="color: #000000;">
</span><span style="color: #008080;"> 5</span> <span style="color: #008080;">var_dump</span><span style="color: #000000;">(</span><span style="color: #800080;">$memcachedServers</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 6</span> <span style="color: #008080;">var_dump</span><span style="color: #000000;">(</span><span style="color: #800080;">$memcache</span><span style="color: #000000;">-&gt;</span><span style="color: #000000;">getVersion());
</span><span style="color: #008080;"> 7</span> <span style="color: #000000;">
</span><span style="color: #008080;"> 8</span> <span style="color: #800080;">$memcache</span><span style="color: #000000;">-&gt;</span><span style="color: #000000;">set(</span><span style="color: #000000;">'</span><span style="color: #000000;">key1</span><span style="color: #000000;">'</span><span style="color: #000000;">,</span><span style="color: #000000;"> </span><span style="color: #000000;">'</span><span style="color: #000000;">value1</span><span style="color: #000000;">'</span><span style="color: #000000;">,</span><span style="color: #000000;"> </span><span style="color: #0000ff;">false</span><span style="color: #000000;">,</span><span style="color: #000000;"> </span><span style="color: #000000;">30</span><span style="color: #000000;">);
</span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">echo</span><span style="color: #000000;"> </span><span style="color: #800080;">$memcache</span><span style="color: #000000;">-&gt;</span><span style="color: #000000;">get(</span><span style="color: #000000;">'</span><span style="color: #000000;">key1</span><span style="color: #000000;">'</span><span style="color: #000000;">);
</span><span style="color: #008080;">10</span> <span style="color: #000000;">
</span><span style="color: #008080;">11</span> <span style="color: #800080;">$memcache</span><span style="color: #000000;">-&gt;</span><span style="color: #000000;">set(</span><span style="color: #000000;">'</span><span style="color: #000000;">var_key</span><span style="color: #000000;">'</span><span style="color: #000000;">,</span><span style="color: #000000;"> </span><span style="color: #000000;">'</span><span style="color: #000000;">some really big variable</span><span style="color: #000000;">'</span><span style="color: #000000;">,</span><span style="color: #000000;"> MEMCACHE_COMPRESSED</span><span style="color: #000000;">,</span><span style="color: #000000;"> </span><span style="color: #000000;">50</span><span style="color: #000000;">);
</span><span style="color: #008080;">12</span> <span style="color: #0000ff;">echo</span><span style="color: #000000;"> </span><span style="color: #800080;">$memcache</span><span style="color: #000000;">-&gt;</span><span style="color: #000000;">get(</span><span style="color: #000000;">'</span><span style="color: #000000;">var_key</span><span style="color: #000000;">'</span><span style="color: #000000;">);</span></div></pre>
<!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>
<p>That&rsquo;s it!</p>
<h2>Conclusion and feedback</h2>
<p>This is just a fun project I&rsquo;ve been working on when lonely and bored on airports. However, if you think this is valuable and in your opinion should be made available as a standard thing in the Windows Azure SDK for PHP, let me know. I&rsquo;ll be happy to push this into the main branch and make sure it&rsquo;s available in a future release.</p>
<p>Comments or praise? There&rsquo;s a comment form right below this post!</p>



